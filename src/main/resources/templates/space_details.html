<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Space Details - StudyRooms')}"></head>

<body th:replace="~{layout :: body('spaces', ~{::content})}">
<div th:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0" th:text="${space.name}">Space name</h2>
        <a th:href="@{/spaces}" class="btn btn-secondary btn-sm">
            Back to Spaces
        </a>
    </div>

    <p th:text="${space.description}">Description</p>

    <p class="mb-4">
        Capacity:
        <span th:text="${space.capacity}">10</span>
        <br>
        Open:
        <span th:text="${space.openTime}">08:00</span>
        -
        <span th:text="${space.closeTime}">20:00</span>
    </p>

    <div class="card mb-4" id="weather-card"
         th:attr="data-lat=${@environment.getProperty('studyrooms.demo.latitude', '37.9838')},
                  data-lon=${@environment.getProperty('studyrooms.demo.longitude', '23.7275')},
                  data-location-label=${@environment.getProperty('studyrooms.demo.location-label', 'Demo campus coordinates')},
                  data-default-date=${selectedDate},
                  data-default-time=${space.openTime}"
    >
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h5 class="card-title mb-1">Weather</h5>
                    <p class="text-muted mb-0 small"
                       th:text="'Using ' + (${@environment.getProperty('studyrooms.demo.location-label', 'demo coordinates')})">
                        Using demo coordinates
                    </p>
                </div>
                <div class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></div>
            </div>
            <form class="row g-2 align-items-end mb-3" data-weather-form>
                <div class="col-12 col-md-auto">
                    <label for="weather-date" class="form-label mb-0 small">Date</label>
                    <input id="weather-date" type="date" class="form-control form-control-sm" data-weather-date>
                </div>
                <div class="col-12 col-md-auto">
                    <label for="weather-time" class="form-label mb-0 small">Time</label>
                    <input id="weather-time" type="time" step="1800" class="form-control form-control-sm" data-weather-time>
                </div>
                <div class="col-12 col-md-auto">
                    <button type="submit" class="btn btn-outline-secondary btn-sm" data-weather-refresh>
                        Update forecast
                    </button>
                </div>
            </form>
            <div class="small" data-weather-content>
                Loading current weather...
            </div>
        </div>
    </div>

    <!-- Date selector -->
    <div class="card mb-3">
        <div class="card-body">
            <form th:action="@{|/spaces/${space.id}|}" method="get"
                  class="row g-2 align-items-end">
                <div class="col-auto">
                    <label for="date" class="form-label mb-0">Select date</label>
                    <input id="date" type="date" name="date"
                           th:value="${selectedDate}"
                           class="form-control">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">
                        Show availability
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Daily availability table -->
    <h4 class="h5 mb-3">
        Availability for <span th:text="${selectedDate}">2025-01-01</span>
    </h4>

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 180px;">Time slot</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody>

            <tr th:each="slot : ${slots}">
                <td>
                    <span th:text="${slot.start}">09:00</span>
                    -
                    <span th:text="${slot.end}">09:30</span>
                </td>
                <td>
                    <span class="badge"
                          th:classappend="${slot.occupied} ? ' bg-danger' : ' bg-success'">
                        <span th:text="${slot.occupied} ? 'Booked' : 'Available'">Available</span>
                    </span>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(slots)}">
                <td colspan="2" class="text-center text-muted">
                    No availability data for this date.
                </td>
            </tr>

            </tbody>
        </table>
    </div>

    <script>
        (() => {
            const card = document.getElementById('weather-card');
            if (!card) {
                return;
            }

            const content = card.querySelector('[data-weather-content]');
            const spinner = card.querySelector('.spinner-border');
            const form = card.querySelector('[data-weather-form]');
            const dateInput = card.querySelector('[data-weather-date]');
            const timeInput = card.querySelector('[data-weather-time]');
            const lat = parseFloat(card.dataset.lat);
            const lon = parseFloat(card.dataset.lon);
            const locationLabel = card.dataset.locationLabel || 'demo coordinates';
            const defaultDate = card.dataset.defaultDate;
            const defaultTime = card.dataset.defaultTime;

            const stopSpinner = () => {
                if (spinner) {
                    spinner.classList.add('d-none');
                }
            };

            const renderMessage = (message) => {
                if (content) {
                    content.textContent = message;
                }
            };

            const ensureDefaults = () => {
                const today = new Date();
                if (dateInput && !dateInput.value) {
                    dateInput.value = defaultDate || today.toISOString().slice(0, 10);
                }
                if (timeInput && !timeInput.value) {
                    timeInput.value = (defaultTime && defaultTime.length === 5 ? defaultTime : '12:00');
                }
            };

            if (Number.isNaN(lat) || Number.isNaN(lon)) {
                stopSpinner();
                renderMessage('Weather unavailable: missing or invalid coordinates.');
                return;
            }

            const fetchWeather = (whenDate, whenTime) => {
                const params = new URLSearchParams({ lat, lon });
                if (whenDate && whenTime) {
                    params.append('at', `${whenDate}T${whenTime}`);
                }

                spinner?.classList.add('d-inline-block');

                fetch(`/api/weather?${params.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Weather service returned an error');
                        }
                        return response.json();
                    })
                    .then(data => {
                        stopSpinner();
                        if (!data) {
                            renderMessage('Weather data is not available right now.');
                            return;
                        }

                        const parts = [];
                        if (typeof data.temperatureCelsius === 'number') {
                            parts.push(`Temperature: ${data.temperatureCelsius.toFixed(1)}Â°C`);
                        }
                        if (typeof data.windSpeed === 'number') {
                            parts.push(`Wind: ${data.windSpeed.toFixed(1)} m/s`);
                        }
                        if (typeof data.precipitation === 'number') {
                            parts.push(`Precipitation: ${data.precipitation.toFixed(1)} mm`);
                        }

                        if (parts.length === 0) {
                            renderMessage('Weather data is not available right now.');
                            return;
                        }

                        const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'selected time';

                        content.innerHTML = `
                        <div class="mb-1">Forecast near ${locationLabel} for ${timestamp}:</div>
                        <ul class="mb-0 ps-3">
                            ${parts.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    `;
                    })
                    .catch(error => {
                        console.warn('Weather fetch failed', error);
                        stopSpinner();
                        renderMessage('Weather service is unavailable right now.');
                    });
            };

            ensureDefaults();

            if (form) {
                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                    if (Number.isNaN(lat) || Number.isNaN(lon)) {
                        renderMessage('Weather unavailable: missing or invalid coordinates.');
                        return;
                    }
                    stopSpinner();
                    spinner?.classList.remove('d-none');
                    fetchWeather(dateInput?.value, timeInput?.value);
                });
            }

            if (Number.isNaN(lat) || Number.isNaN(lon)) {
                stopSpinner();
                renderMessage('Weather unavailable: missing or invalid coordinates.');
                return;
            }

            fetchWeather(dateInput?.value, timeInput?.value);
        })();
    </script>

</div>
</body>
</html>
